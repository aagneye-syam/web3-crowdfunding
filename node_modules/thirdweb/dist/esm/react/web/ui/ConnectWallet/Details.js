"use client";
import { jsx as _jsx, Fragment as _Fragment, jsxs as _jsxs } from "react/jsx-runtime";
import styled from "@emotion/styled";
import { ChevronRightIcon, ExitIcon, PaperPlaneIcon, PinBottomIcon, PlusIcon, TextAlignJustifyIcon, } from "@radix-ui/react-icons";
import { useQuery } from "@tanstack/react-query";
import { useEffect, useState } from "react";
import { ethereum } from "../../../../chains/chain-definitions/ethereum.js";
import { getContract } from "../../../../contract/contract.js";
import { resolveAvatar } from "../../../../extensions/ens/resolve-avatar.js";
import { resolveName } from "../../../../extensions/ens/resolve-name.js";
import { isContractDeployed } from "../../../../utils/bytecode/is-contract-deployed.js";
import { useChainQuery, useChainsQuery, } from "../../../core/hooks/others/useChainQuery.js";
import { useWalletBalance } from "../../../core/hooks/others/useWalletBalance.js";
import { useConnectUI } from "../../../core/hooks/others/useWalletConnectionCtx.js";
import { useActiveAccount, useActiveWallet, useActiveWalletChain, useDisconnect, useSwitchActiveWalletChain, } from "../../../core/hooks/wallets/wallet-hooks.js";
import { shortenString } from "../../../core/utils/addresses.js";
import { hasSmartAccount } from "../../utils/isSmartWallet.js";
import { ChainIcon } from "../components/ChainIcon.js";
import { CopyIcon } from "../components/CopyIcon.js";
import { Img } from "../components/Img.js";
import { Modal } from "../components/Modal.js";
import { Skeleton } from "../components/Skeleton.js";
import { Spacer } from "../components/Spacer.js";
import { Spinner } from "../components/Spinner.js";
import { WalletImage } from "../components/WalletImage.js";
import { Container, Line } from "../components/basic.js";
import { Button, IconButton } from "../components/buttons.js";
import { Link, Text } from "../components/text.js";
import { useCustomTheme } from "../design-system/CustomThemeProvider.js";
import { fadeInAnimation } from "../design-system/animations.js";
import { StyledButton } from "../design-system/elements.js";
import { fontSize, iconSize, media, radius, spacing, } from "../design-system/index.js";
import { NetworkSelectorContent } from "./NetworkSelector.js";
import { onModalUnmount } from "./constants.js";
import { FundsIcon } from "./icons/FundsIcon.js";
import { SmartWalletBadgeIcon } from "./icons/SmartAccountBadgeIcon.js";
import { WalletIcon } from "./icons/WalletIcon.js";
import { genericTokenIcon } from "./icons/dataUris.js";
import { LazyBuyScreen } from "./screens/Buy/LazyBuyScreen.js";
import { BuyTxHistory } from "./screens/Buy/tx-history/BuyTxHistory.js";
import { ReceiveFunds } from "./screens/ReceiveFunds.js";
import { SendFunds } from "./screens/SendFunds.js";
import { ViewFunds } from "./screens/ViewFunds.js";
const TW_CONNECTED_WALLET = "tw-connected-wallet";
const LocalhostChainId = 1337;
/**
 * @internal
 */
export const ConnectedWalletDetails = (props) => {
    const { connectLocale: locale, client } = useConnectUI();
    const activeWallet = useActiveWallet();
    const activeAccount = useActiveAccount();
    const walletChain = useActiveWalletChain();
    const chainQuery = useChainQuery(walletChain);
    const { disconnect } = useDisconnect();
    // prefetch chains metadata with low concurrency
    useChainsQuery(props.chains, 5);
    const tokenAddress = walletChain && props.detailsButton?.displayBalanceToken
        ? props.detailsButton.displayBalanceToken[Number(walletChain.id)]
        : undefined;
    const balanceQuery = useWalletBalance({
        chain: walletChain ? walletChain : undefined,
        tokenAddress,
        address: activeAccount?.address,
        client,
    });
    const [screen, setScreen] = useState("main");
    const [isOpen, setIsOpen] = useState(false);
    const ensNameQuery = useQuery({
        queryKey: ["ens-name", activeAccount?.address],
        enabled: !!activeAccount?.address,
        queryFn: () => resolveName({
            client,
            address: activeAccount?.address || "",
            resolverChain: ethereum,
        }),
    });
    const ensAvatarQuery = useQuery({
        queryKey: ["ens-avatar", ensNameQuery.data],
        enabled: !!ensNameQuery.data,
        queryFn: async () => resolveAvatar({
            client,
            name: ensNameQuery.data || "",
        }),
    });
    // const personalAccount = (activeWallet as WalletWithPersonalAccount)
    //   ?.personalAccount;
    // const smartWallet = activeWallet
    //   ? personalAccountToSmartAccountMap.get(activeWallet.getAccount())
    //   : undefined;
    const disableSwitchChain = !activeWallet?.switchChain;
    // const isActuallyMetaMask =
    //   activeWallet && activeWallet instanceof MetaMaskWallet;
    const shortAddress = activeAccount?.address
        ? shortenString(activeAccount.address, false)
        : "";
    const addressOrENS = ensNameQuery.data || shortAddress;
    useEffect(() => {
        if (!isOpen) {
            onModalUnmount(() => {
                setScreen("main");
            });
        }
    }, [isOpen]);
    // if (activeWallet && "isSmartWallet" in activeWallet) {
    //   avatarOrWalletIconUrl = smartWalletMetadata.iconUrl;
    // }
    const isNetworkMismatch = props.chain && walletChain && walletChain.id !== props.chain.id;
    // Note: Must wrap the `SwitchNetworkButton` in a fragment to avoid warning from radix-ui
    // Note: Must wrap the `detailsButton.render` in an container element
    const trigger = props.detailsButton?.render ? (_jsx("div", { children: _jsx(props.detailsButton.render, {}) })) : props.chain && isNetworkMismatch ? (_jsx(_Fragment, { children: _jsx(SwitchNetworkButton, { style: props.switchButton?.style, className: props.switchButton?.className, switchNetworkBtnTitle: props.switchButton?.label, targetChain: props.chain }) })) : (_jsxs(WalletInfoButton, { type: "button", className: `${TW_CONNECTED_WALLET} ${props.detailsButton?.className || ""}`, style: props.detailsButton?.style, "data-test": "connected-wallet-details", children: [ensAvatarQuery.data ? (_jsx(Img, { src: ensAvatarQuery.data, width: iconSize.lg, height: iconSize.lg, style: {
                    borderRadius: radius.sm,
                }, client: client })) : activeWallet?.id ? (_jsx(WalletImage, { size: iconSize.lg, id: activeWallet.id, client: client })) : (_jsx(WalletIcon, { size: iconSize.lg })), _jsxs(Container, { flex: "column", gap: "xxs", children: [addressOrENS ? (_jsx(Text, { size: "sm", color: "primaryText", weight: 500, className: `${TW_CONNECTED_WALLET}__address`, children: addressOrENS })) : (_jsx(Skeleton, { height: fontSize.sm, width: "88px" })), balanceQuery.data ? (_jsxs(Text, { className: `${TW_CONNECTED_WALLET}__balance`, size: "xs", weight: 500, children: [Number(balanceQuery.data.displayValue).toFixed(3), " ", balanceQuery.data.symbol] })) : (_jsx(Skeleton, { height: fontSize.xs, width: "82px" }))] })] }));
    const networkSwitcherButton = (_jsxs(MenuButton, { type: "button", disabled: disableSwitchChain, onClick: () => {
            setScreen("network-switcher");
        }, "data-variant": "primary", children: [_jsx("div", { style: {
                    display: "flex",
                    alignItems: "center",
                    position: "relative",
                }, children: chainQuery.data ? (_jsx(ChainIcon, { chainIcon: chainQuery.data?.icon, size: iconSize.md, active: true, client: client })) : (_jsx(Skeleton, { height: iconSize.md, width: iconSize.md })) }), chainQuery.isLoading ? (_jsx(Skeleton, { height: "16px", width: "200px" })) : (_jsx(Text, { color: "primaryText", multiline: true, children: chainQuery.data?.name || `Unknown chain #${walletChain?.id}` })), _jsx(StyledChevronRightIcon, { width: iconSize.sm, height: iconSize.sm, style: {
                    flexShrink: 0,
                    marginLeft: "auto",
                } })] }));
    let content = (_jsxs("div", { children: [_jsx(Spacer, { y: "xl" }), _jsxs(Container, { px: "lg", flex: "column", center: "x", children: [ensAvatarQuery.data ? (_jsx(Img, { src: ensAvatarQuery.data, width: iconSize.xxl, height: iconSize.xxl, style: {
                            borderRadius: radius.lg,
                        }, client: client })) : activeWallet?.id ? (_jsx(WalletImage, { size: iconSize.xxl, id: activeWallet.id, client: client })) : (_jsx(WalletIcon, { size: iconSize.xxl })), _jsx(Spacer, { y: "md" }), _jsx(ConnectedToSmartWallet, {}), (activeWallet?.id === "embedded" || activeWallet?.id === "inApp") && (_jsx(InAppWalletUserInfo, {})), _jsxs("div", { style: {
                            display: "flex",
                            gap: spacing.xxs,
                            alignItems: "center",
                            transform: "translateX(10px)",
                        }, "data-test": "connected-wallet-address", "data-address": activeAccount?.address, children: [_jsx(Text, { color: "primaryText", weight: 500, size: "md", children: addressOrENS }), _jsx(IconButton, { style: {
                                    padding: "3px",
                                }, "data-test": "copy-address", children: _jsx(CopyIcon, { text: activeAccount?.address || "", tip: locale.copyAddress, side: "top" }) })] }), _jsx(Spacer, { y: "xxs" }), _jsxs(Text, { weight: 500, size: "sm", children: [balanceQuery.data ? (Number(balanceQuery.data.displayValue).toFixed(3)) : (_jsx(Skeleton, { height: "1em", width: "100px" })), " ", balanceQuery.data?.symbol, " "] })] }), _jsx(Spacer, { y: "lg" }), _jsx(Container, { px: "lg", children: _jsxs(Container, { style: {
                        display: "grid",
                        gridTemplateColumns: "1fr 1fr 1fr",
                        gap: spacing.xs,
                    }, children: [_jsxs(Button, { variant: "outline", style: {
                                fontSize: fontSize.sm,
                                display: "flex",
                                gap: spacing.xs,
                                alignItems: "center",
                                padding: spacing.sm,
                            }, onClick: () => {
                                setScreen("send");
                            }, children: [_jsx(Container, { color: "secondaryText", flex: "row", center: "both", children: _jsx(PaperPlaneIcon, { width: iconSize.sm, height: iconSize.sm, style: {
                                            transform: "translateY(-10%) rotate(-45deg) ",
                                        } }) }), locale.send] }), _jsxs(Button, { variant: "outline", style: {
                                fontSize: fontSize.sm,
                                display: "flex",
                                gap: spacing.xs,
                                alignItems: "center",
                                padding: spacing.sm,
                            }, onClick: () => {
                                setScreen("receive");
                            }, children: [_jsxs(Container, { color: "secondaryText", flex: "row", center: "both", children: [_jsx(PinBottomIcon, { width: iconSize.sm, height: iconSize.sm }), " "] }), locale.receive, " "] }), _jsxs(Button, { variant: "outline", style: {
                                fontSize: fontSize.sm,
                                display: "flex",
                                gap: spacing.xs,
                                alignItems: "center",
                                padding: spacing.sm,
                            }, onClick: () => {
                                setScreen("buy");
                            }, children: [_jsx(Container, { color: "secondaryText", flex: "row", center: "both", children: _jsx(PlusIcon, { width: iconSize.sm, height: iconSize.sm }) }), locale.buy] })] }) }), _jsx(Spacer, { y: "md" }), _jsxs(Container, { px: "md", children: [_jsxs(Container, { flex: "column", style: {
                            gap: "1px",
                        }, children: [networkSwitcherButton, _jsxs(MenuButton, { onClick: () => {
                                    setScreen("pending-tx");
                                }, style: {
                                    fontSize: fontSize.sm,
                                }, children: [_jsx(TextAlignJustifyIcon, { width: iconSize.md, height: iconSize.md }), _jsx(Container, { flex: "row", gap: "xs", center: "y", children: _jsx(Text, { color: "primaryText", children: locale.transactions }) })] }), _jsxs(MenuButton, { onClick: () => {
                                    setScreen("view-funds");
                                }, style: {
                                    fontSize: fontSize.sm,
                                }, children: [_jsx(Img, { width: iconSize.md, height: iconSize.md, src: genericTokenIcon, client: client }), _jsx(Text, { color: "primaryText", children: "View Funds" })] }), (props.detailsModal?.showTestnetFaucet ?? false) &&
                                ((chainQuery.data?.faucets && chainQuery.data.faucets.length > 0) ||
                                    chainQuery.data?.chainId === LocalhostChainId) && (_jsxs(MenuLink, { href: chainQuery.data?.faucets ? chainQuery.data.faucets[0] : "#", target: "_blank", as: "a", style: {
                                    textDecoration: "none",
                                    color: "inherit",
                                }, children: [_jsx(Container, { flex: "row", center: "both", color: "secondaryText", children: _jsx(FundsIcon, { size: iconSize.md }) }), locale.requestTestnetFunds] })), props.detailsModal?.footer && (_jsx(props.detailsModal.footer, { close: () => setIsOpen(false) }))] }), _jsx(Spacer, { y: "md" })] }), props.detailsModal?.hideDisconnect !== true && (_jsxs(Container, { children: [_jsx(Line, {}), _jsx(Spacer, { y: "sm" }), _jsx(Container, { px: "md", children: _jsxs(MenuButton, { "data-variant": "danger", type: "button", onClick: () => {
                                if (activeWallet) {
                                    disconnect(activeWallet);
                                    props.onDisconnect();
                                }
                            }, children: [_jsx(ExitIcon, { width: iconSize.md, height: iconSize.md }), _jsx(Text, { color: "primaryText", children: locale.disconnectWallet })] }) }), _jsx(Spacer, { y: "sm" })] }))] }));
    if (screen === "pending-tx") {
        content = (_jsx(BuyTxHistory, { isBuyForTx: false, isEmbed: false, onBack: () => setScreen("main"), client: client, onDone: () => {
                setIsOpen(false);
            } }));
    }
    if (screen === "network-switcher") {
        content = (_jsx(NetworkSelectorContent
        // add currently connected chain to the list of chains if it's not already in the list
        , { 
            // add currently connected chain to the list of chains if it's not already in the list
            chains: walletChain &&
                props.chains.find((c) => c.id === walletChain.id) === undefined
                ? [walletChain, ...props.chains]
                : props.chains, closeModal: () => {
                setIsOpen(false);
            }, networkSelector: props.detailsModal?.networkSelector, onBack: () => {
                setScreen("main");
            }, connectLocale: locale, client: client }));
    }
    // export local wallet
    // else if (screen === "export") {
    //   content = (
    //     <ExportLocalWallet
    //       onExport={() => {
    //         setIsOpen(false);
    //       }}
    //       onBack={() => {
    //         setScreen("main");
    //       }}
    //     />
    //   );
    // }
    // send funds
    else if (screen === "view-funds") {
        content = (_jsx(ViewFunds, { supportedTokens: props.supportedTokens, onBack: () => {
                setScreen("main");
            }, client: client }));
    }
    // send funds
    else if (screen === "send") {
        content = (_jsx(SendFunds, { supportedTokens: props.supportedTokens, onBack: () => {
                setScreen("main");
            } }));
    }
    // receive funds
    else if (screen === "receive") {
        content = (_jsx(ReceiveFunds, { walletId: activeWallet?.id, onBack: () => {
                setScreen("main");
            } }));
    }
    // thirdweb pay
    else if (screen === "buy") {
        content = (_jsx(LazyBuyScreen, { isEmbed: false, client: client, onBack: () => setScreen("main"), supportedTokens: props.supportedTokens, onViewPendingTx: () => setScreen("pending-tx"), connectLocale: locale, payOptions: props.detailsModal?.payOptions || {}, theme: typeof props.theme === "string" ? props.theme : props.theme.type, onDone: () => {
                setIsOpen(false);
            } }));
    }
    return (_jsx(Modal, { size: "compact", trigger: trigger, open: isOpen, setOpen: setIsOpen, children: content }));
};
const WalletInfoButton = /* @__PURE__ */ StyledButton(() => {
    const theme = useCustomTheme();
    return {
        all: "unset",
        background: theme.colors.connectedButtonBg,
        border: `1px solid ${theme.colors.borderColor}`,
        padding: `${spacing.sm} ${spacing.sm}`,
        borderRadius: radius.lg,
        cursor: "pointer",
        display: "inline-flex",
        alignItems: "center",
        minWidth: "180px",
        gap: spacing.sm,
        boxSizing: "border-box",
        WebkitTapHighlightColor: "transparent",
        lineHeight: "normal",
        animation: `${fadeInAnimation} 300ms ease`,
        [media.mobile]: {
            gap: spacing.sm,
            padding: `${spacing.xs} ${spacing.sm}`,
            img: {
                width: `${iconSize.md}px`,
                height: `${iconSize.md}px`,
            },
        },
        "&:hover": {
            transition: "background 250ms ease",
            background: theme.colors.connectedButtonBgHover,
        },
    };
});
const MenuButton = /* @__PURE__ */ StyledButton(() => {
    const theme = useCustomTheme();
    return {
        all: "unset",
        padding: `${spacing.sm} ${spacing.sm}`,
        borderRadius: radius.md,
        backgroundColor: "transparent",
        // border: `1px solid ${theme.colors.borderColor}`,
        boxSizing: "border-box",
        display: "flex",
        alignItems: "center",
        width: "100%",
        cursor: "pointer",
        fontSize: fontSize.md,
        fontWeight: 500,
        color: theme.colors.secondaryText,
        gap: spacing.sm,
        WebkitTapHighlightColor: "transparent",
        lineHeight: 1.3,
        transition: "background-color 200ms ease, transform 200ms ease",
        "&:hover": {
            backgroundColor: theme.colors.tertiaryBg,
            transform: "scale(1.01)",
            svg: {
                color: theme.colors.accentText,
            },
        },
        "&[disabled]": {
            cursor: "not-allowed",
            svg: {
                display: "none",
            },
        },
        svg: {
            color: theme.colors.secondaryText,
            transition: "color 200ms ease",
        },
        "&[data-variant='danger']:hover svg": {
            color: `${theme.colors.danger}!important`,
        },
        "&[data-variant='primary']:hover svg": {
            color: `${theme.colors.primaryText}!important`,
        },
    };
});
const MenuLink = /* @__PURE__ */ (() => MenuButton.withComponent("a"))();
const StyledChevronRightIcon = /* @__PURE__ */ styled(
/* @__PURE__ */ ChevronRightIcon)(() => {
    const theme = useCustomTheme();
    return {
        color: theme.colors.secondaryText,
    };
});
// function AccountSwitcher(props: { wallet: Wallet; name: string }) {
//   const { connect } = useConnect();
//   const locale = useTWLocale().connectWallet;
//   const activeWallet = useActiveWallet();
//   return (
//     <MenuButton
//       type="button"
//       onClick={() => {
//         // remove the current active account as "connected"
//         if (activeWallet) {
//           connectionManager.removeConnectedWallet(activeWallet);
//         }
//         // set as connected and active
//         connect(props.wallet);
//       }}
//       style={{
//         fontSize: fontSize.sm,
//       }}
//     >
//       <EnterIcon width={iconSize.md} height={iconSize.md} />
//       <Text color="primaryText">
//         {locale.switchTo} {props.name}
//       </Text>
//     </MenuButton>
//   );
// }
function ConnectedToSmartWallet() {
    const activeAccount = useActiveAccount();
    const activeWallet = useActiveWallet();
    const isSmartWallet = hasSmartAccount(activeWallet);
    const chain = useActiveWalletChain();
    const { client, connectLocale: locale } = useConnectUI();
    const [isSmartWalletDeployed, setIsSmartWalletDeployed] = useState(false);
    useEffect(() => {
        if (activeAccount && isSmartWallet && activeAccount.address && chain) {
            const contract = getContract({
                address: activeAccount.address,
                chain,
                client,
            });
            isContractDeployed(contract).then((isDeployed) => {
                setIsSmartWalletDeployed(isDeployed);
            });
        }
        else {
            setIsSmartWalletDeployed(false);
        }
    }, [activeAccount, chain, client, isSmartWallet]);
    const content = (_jsxs(Container, { flex: "row", bg: "secondaryButtonBg", gap: "xxs", style: {
            borderRadius: radius.md,
            padding: `${spacing.xxs} ${spacing.sm} ${spacing.xxs} ${spacing.xs}`,
        }, center: "y", children: [_jsx(Container, { flex: "row", color: "accentText", center: "both", children: _jsx(SmartWalletBadgeIcon, { size: iconSize.xs }) }), _jsx(Text, { size: "xs", color: "secondaryButtonText", children: locale.connectedToSmartWallet })] }));
    if (chain && activeAccount && isSmartWallet) {
        return (_jsxs(_Fragment, { children: [isSmartWalletDeployed ? (_jsx(Link, { color: "secondaryText", hoverColor: "primaryText", href: `https://thirdweb.com/${chain.id}/${activeAccount.address}/account`, target: "_blank", size: "sm", children: content })) : (_jsxs(Text, { size: "sm", children: [" ", content] })), _jsx(Spacer, { y: "xs" })] }));
    }
    return null;
}
function InAppWalletUserInfo() {
    const { client } = useConnectUI();
    const account = useActiveAccount();
    const userInfoQuery = useQuery({
        queryKey: ["in-app-wallet-user", client, account?.address],
        queryFn: async () => {
            const { getUserEmail, getUserPhoneNumber } = await import("../../../../wallets/in-app/core/authentication/index.js");
            const [email, phone] = await Promise.all([
                getUserEmail({
                    client: client,
                }),
                getUserPhoneNumber({
                    client: client,
                }),
            ]);
            return email || phone || null;
        },
    });
    if (userInfoQuery.data) {
        return (_jsx(Container, { flex: "row", center: "x", style: {
                paddingBottom: spacing.xs,
            }, children: _jsx(Text, { size: "sm", children: userInfoQuery.data }) }));
    }
    return null;
}
/**
 * @internal
 */
function SwitchNetworkButton(props) {
    const switchChain = useSwitchActiveWalletChain();
    const [switching, setSwitching] = useState(false);
    const locale = useConnectUI().connectLocale;
    const switchNetworkBtnTitle = props.switchNetworkBtnTitle ?? locale.switchNetwork;
    return (_jsx(Button, { className: `tw-connect-wallet--switch-network ${props.className || ""}`, variant: "primary", type: "button", "data-is-loading": switching, "data-test": "switch-network-button", disabled: switching, onClick: async () => {
            setSwitching(true);
            try {
                await switchChain(props.targetChain);
            }
            catch (e) {
                console.error(e);
            }
            setSwitching(false);
        }, style: {
            minWidth: "140px",
            ...props.style,
        }, "aria-label": switching ? locale.switchingNetwork : undefined, children: switching ? (_jsx(Spinner, { size: "sm", color: "primaryButtonText" })) : (switchNetworkBtnTitle) }));
}
//# sourceMappingURL=Details.js.map